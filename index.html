<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1177 v. Chr. - Die erste Apokalypse</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* DESIGN SYSTEM: BRONZE AGE AESTHETIC */
        :root {
            --color-egypt: #eab308; /* Gold */
            --color-hittite: #7f1d1d; /* Dunkelrot */
            --color-mycenae: #ea580c; /* Terrakotta */
            --color-sea: #dc2626; /* Blutrot (Feind) */
            --color-tin: #64748b; /* Zinn-Grau */
            --glass: rgba(255, 255, 255, 0.95);
        }

        body { margin: 0; font-family: 'Lato', sans-serif; background: #d6d3d1; overflow: hidden; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        #map { height: 100vh; width: 100vw; z-index: 1; background: #e5e5e4; }
        
        /* UI LAYERS */
        .ui-layer { position: absolute; z-index: 3000; pointer-events: none; }
        .ui-element { pointer-events: auto; }

        /* NARRATIVE CARDS (Die "Kacheln") */
        .story-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-20px);
            opacity: 0;
        }
        .story-card.active { transform: translateY(0); opacity: 1; }
        
        /* MAP ANIMATIONS */
        @keyframes flow { to { stroke-dashoffset: -20; } }
        .route-line { animation: flow 1s linear infinite; stroke-dasharray: 4, 8; }
        .route-dead { stroke-dasharray: 1, 10; opacity: 0.3; animation: none; filter: grayscale(1); }
        
        @keyframes pulse-city { 0% { stroke-width: 2px; } 50% { stroke-width: 6px; } 100% { stroke-width: 2px; } }
        .city-marker { transition: all 1s ease; }
        .city-capital { animation: pulse-city 3s infinite; }
        
        /* ATTACK VECTORS */
        .attack-arrow { filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5)); }
        @keyframes attack-slide { 0% { transform: translate(-20px, -20px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translate(0, 0); opacity: 1; } }
        .vector-anim { animation: attack-slide 2s ease-out forwards; }

    </style>
</head>
<body class="text-stone-800">

    <div id="map"></div>

    <div class="ui-layer top-0 left-0 right-0 p-6 flex justify-between items-start">
        <div class="ui-element bg-white/90 backdrop-blur px-6 py-4 rounded-xl border-l-4 border-amber-600 shadow-lg">
            <h1 class="text-2xl font-cinzel font-bold text-stone-900">1177 v. Chr.</h1>
            <p class="text-xs text-stone-500 font-mono tracking-widest uppercase mt-1">Die erste Apokalypse</p>
        </div>
        
        <div class="ui-element flex gap-2">
            <button onclick="clearApiKey()" class="bg-white/90 p-2 rounded-lg shadow hover:text-red-600 transition-colors text-xs font-bold uppercase tracking-wider">
                <i class="ph-bold ph-key"></i> Reset
            </button>
        </div>
    </div>

    <div id="narrative-container" class="ui-layer top-28 left-4 md:left-auto md:right-12 md:w-[450px] z-[4000]">
        <div id="story-card" class="story-card ui-element rounded-xl overflow-hidden border-l-8 border-amber-600 hidden">
            <div class="h-32 bg-stone-800 relative overflow-hidden">
                <img id="card-img" src="" class="w-full h-full object-cover opacity-60 mix-blend-overlay">
                <div class="absolute bottom-0 left-0 p-4">
                    <span id="card-date" class="text-amber-400 text-xs font-bold font-mono bg-black/50 px-2 py-1 rounded">1200 v. Chr.</span>
                </div>
            </div>
            
            <div class="p-6 bg-white/95">
                <h2 id="card-title" class="font-cinzel text-2xl font-bold text-stone-900 mb-2"></h2>
                <p id="card-desc" class="text-stone-600 text-sm leading-relaxed mb-4"></p>
                
                <div class="bg-stone-100 border-l-2 border-stone-400 p-3 mb-4 italic text-xs text-stone-500 font-serif">
                    <i class="ph-fill ph-quotes text-stone-300 mr-1"></i> <span id="card-quote"></span>
                </div>

                <button onclick="askGeminiEvent()" class="w-full bg-stone-800 hover:bg-amber-700 text-white py-3 rounded-lg flex items-center justify-center gap-2 transition-colors text-sm font-bold shadow-md">
                    <i class="ph-fill ph-sparkle"></i> Hintergr√ºnde analysieren
                </button>
            </div>
        </div>
    </div>

    <div id="chat-modal" class="hidden fixed inset-0 z-[5000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden border border-stone-400">
            <div class="bg-stone-100 p-4 border-b border-stone-200 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="chat-avatar" class="w-10 h-10 rounded-full bg-stone-300 flex items-center justify-center text-xl">üèõÔ∏è</div>
                    <div>
                        <h3 id="chat-role" class="font-cinzel font-bold text-stone-900">Das Orakel</h3>
                        <p class="text-[10px] uppercase tracking-widest text-stone-500">Gemini 3 Analysis</p>
                    </div>
                </div>
                <button onclick="closeChat()" class="hover:bg-stone-200 rounded-full p-2"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div id="chat-history" class="flex-1 p-6 overflow-y-auto bg-stone-50 flex flex-col gap-4"></div>
            
            <div class="p-4 bg-white border-t border-stone-200 flex gap-2">
                <input type="text" id="chat-input" placeholder="Stellen Sie eine Nachfrage..." class="flex-1 border border-stone-300 rounded px-4 py-3 font-serif text-sm focus:outline-none focus:ring-2 focus:ring-amber-600" onkeypress="if(event.key === 'Enter') sendMsg()">
                <button onclick="sendMsg()" class="bg-stone-800 text-white px-6 rounded hover:bg-amber-700"><i class="ph-bold ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <div class="ui-layer bottom-0 left-0 right-0 p-0 pointer-events-none">
        <div class="ui-element bg-white/95 border-t border-stone-200 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] p-6 pb-10">
            <div class="max-w-5xl mx-auto flex items-center gap-8">
                
                <button id="play-btn" onclick="togglePlay()" class="w-16 h-16 bg-stone-900 hover:bg-amber-600 text-white rounded-full flex items-center justify-center shadow-2xl transition-all hover:scale-105 active:scale-95 flex-shrink-0">
                    <i id="play-icon" class="ph-fill ph-play text-3xl ml-1"></i>
                </button>

                <div class="flex-grow">
                    <div class="flex justify-between items-end mb-3">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-stone-400 block mb-1">Jahr</span>
                            <div class="font-cinzel text-4xl font-bold text-stone-800 tabular-nums leading-none">
                                <span id="year-display">1220</span> <span class="text-base text-stone-500">v. Chr.</span>
                            </div>
                        </div>
                        
                        <div class="flex bg-stone-100 rounded-lg p-1 gap-1 border border-stone-200">
                            <button onclick="setSpeed(0.05)" id="spd-1" class="px-4 py-1 text-xs font-bold rounded bg-white shadow-sm text-stone-900">Langsam</button>
                            <button onclick="setSpeed(0.2)" id="spd-2" class="px-4 py-1 text-xs font-bold rounded text-stone-500 hover:bg-white hover:text-stone-900">Mittel</button>
                            <button onclick="setSpeed(0.6)" id="spd-3" class="px-4 py-1 text-xs font-bold rounded text-stone-500 hover:bg-white hover:text-stone-900">Schnell</button>
                        </div>
                    </div>
                    
                    <input type="range" id="time-slider" min="0" max="90" value="0" step="0.1" oninput="manualTime(this.value)" class="w-full accent-amber-600 h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                    
                    <div class="flex justify-between text-[10px] text-stone-400 font-mono mt-2 uppercase tracking-wider">
                        <span>Goldenes Zeitalter</span>
                        <span>Erste Risse</span>
                        <span>Der Kollaps</span>
                        <span>Dunkles Zeitalter</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="key-modal" class="hidden fixed inset-0 z-[9999] bg-stone-900/90 backdrop-blur flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 border border-stone-200 text-center">
            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üîë</div>
            <h2 class="font-cinzel font-bold text-2xl mb-2 text-stone-900">Verbindung herstellen</h2>
            <p class="text-sm text-stone-500 mb-6">Geben Sie Ihren API-Key ein, um die KI-Personas (K√∂nige, Gener√§le) zu aktivieren.</p>
            <input type="password" id="api-key-input" placeholder="Google Gemini API Key" class="w-full p-4 bg-stone-50 border border-stone-300 rounded-lg mb-4 font-mono text-sm focus:ring-2 focus:ring-amber-500 outline-none">
            <button onclick="saveApiKey()" class="w-full bg-stone-900 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition-colors uppercase tracking-widest text-xs">Starten</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /* --- DREHBUCH (DATA SCRIPT) --- */
        
        // 1. Die Akteure (Factions)
        const actors = {
            hittite: { name: "Hethiter Reich", color: "#7f1d1d", icon: "ü¶Å", prompt: "Du bist Suppiluliuma II., Gro√ük√∂nig der Hethiter. Dein Reich hungert, die Vasallen rebellieren." },
            mycenae: { name: "Mykene", color: "#ea580c", icon: "üè∫", prompt: "Du bist der Wanax (K√∂nig) von Mykene. Deine Pal√§ste sind Festungen, aber der Handel bricht zusammen." },
            egypt: { name: "√Ñgypten", color: "#eab308", icon: "‚òÄÔ∏è", prompt: "Du bist Ramses III., Pharao. Du bist der Fels in der Brandung, aber die Barbaren kommen." },
            ugarit: { name: "Ugarit", color: "#7e22ce", icon: "‚öñÔ∏è", prompt: "Du bist Ammurapi III., K√∂nig von Ugarit. Du bist H√§ndler, kein Krieger. Deine Schiffe sind fort." },
            sea: { name: "Seev√∂lker", color: "#dc2626", icon: "üî•", prompt: "Beschreibe die Zerst√∂rung aus Sicht eines namenlosen Pl√ºnderers." }
        };

        // 2. Die Orte (Stage)
        const locations = [
            { name: "Hattusa", lat: 40.01, lng: 34.61, faction: "hittite", type: "capital" },
            { name: "Mykene", lat: 37.73, lng: 22.75, faction: "mycenae", type: "capital" },
            { name: "Ugarit", lat: 35.60, lng: 35.78, faction: "ugarit", type: "trade" },
            { name: "Pi-Ramesse", lat: 30.79, lng: 31.82, faction: "egypt", type: "capital" },
            { name: "Enkomi (Zypern)", lat: 35.16, lng: 33.88, faction: "ugarit", type: "resource" } // Kupfer
        ];

        // 3. Das Drehbuch (Timeline Events)
        const script = [
            {
                year: 1208,
                title: "Der erste Warnschuss",
                desc: "Libyer und 'V√∂lker aus dem Norden' greifen das Nildelta an. Pharao Merenptah schl√§gt sie zur√ºck, aber die Welt erzittert.",
                quote: "Sie kamen, um den Bauch √Ñgyptens zu f√ºllen.",
                type: "battle",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Merneptah_Stele_Cairo.jpg/300px-Merneptah_Stele_Cairo.jpg",
                vector: { from: [32.0, 25.0], to: [30.8, 30.0] } // Libyen Angriff
            },
            {
                year: 1200,
                title: "Der Hunger",
                desc: "D√ºrre in Anatolien. Die Hethiter bitten √Ñgypten verzweifelt um Getreide. Das komplexe Logistiksystem beginnt zu wanken.",
                quote: "Es ist eine Frage von Leben und Tod.",
                type: "crisis",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Hittite_Grain_Silo.jpg/320px-Hittite_Grain_Silo.jpg", // Platzhalter
                effect: "routes_strain"
            },
            {
                year: 1190,
                title: "Das Herz h√∂rt auf zu schlagen",
                desc: "Ugarit, das globale Handelszentrum, wird vernichtet. Da die Truppen in Anatolien k√§mpfen, ist die Stadt schutzlos. Der Handel bricht zusammen.",
                quote: "Meine Schiffe sind im Lukka-Land, meine Truppen in Hatti.",
                type: "collapse",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Ugarit_palace_ruins.jpg/320px-Ugarit_palace_ruins.jpg",
                vector: { from: [35.0, 33.0], to: [35.6, 35.78] }, // Angriff von See
                effect: "ugarit_fall"
            },
            {
                year: 1180,
                title: "Der Riese f√§llt",
                desc: "Hattusa, die unbesiegbare Stadt der Hethiter, wird aufgegeben und brennt. Ein 400 Jahre altes Imperium verschwindet.",
                quote: "Die G√∂tter haben Hatti verlassen.",
                type: "collapse",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Lion_Gate_Hattusa.jpg/320px-Lion_Gate_Hattusa.jpg",
                effect: "hittite_fall"
            },
            {
                year: 1177,
                title: "Die Entscheidung",
                desc: "Die Seev√∂lker erreichen √Ñgypten. Ramses III. lockt ihre Flotte in das Nildelta und vernichtet sie. √Ñgypten √ºberlebt, ist aber bankrott.",
                quote: "Sie drangen in die Kan√§le ein wie Wasserv√∂gel.",
                type: "battle",
                img: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Ramses_III_Sea_Peoples.jpg/320px-Ramses_III_Sea_Peoples.jpg",
                vector: { from: [32.0, 34.0], to: [31.5, 32.0] } // Angriff auf Delta
            }
        ];

        /* --- ENGINE --- */
        const START_YEAR = 1220;
        const END_YEAR = 1130;
        let currentYear = START_YEAR;
        let isPlaying = false;
        let speed = 0.05;
        let map;
        let activeEvent = null;
        let layers = { cities: [], vectors: [], routes: [] };
        let chatContext = [];

        window.onload = function() {
            getApiKey();
            initMap();
            requestAnimationFrame(loop);
        };

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false, zoomSnap: 0.1 }).setView([35.5, 30.0], 5.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png').addTo(map);

            // St√§dte initialisieren
            locations.forEach(loc => {
                const color = actors[loc.faction].color;
                const m = L.circleMarker([loc.lat, loc.lng], {
                    radius: loc.type === 'capital' ? 8 : 5,
                    color: '#fff', fillColor: color, weight: 2, fillOpacity: 1
                }).addTo(map);
                
                m.bindTooltip(loc.name, { permanent: true, direction: 'bottom', className: 'font-cinzel text-xs font-bold text-stone-600 bg-transparent shadow-none border-none' });
                m.on('click', () => openActorChat(loc));
                layers.cities.push({ marker: m, data: loc });
            });

            // Routen (statisch f√ºr Demo, dynamisch im Effekt)
            const tinRoute = L.polyline([[35.6, 35.78], [35.2, 25.1], [37.7, 22.7]], { color: '#64748b', weight: 3, className: 'route-line' }).addTo(map);
            layers.routes.push({ line: tinRoute, id: 'tin' });
        }

        function loop() {
            if (isPlaying && !activeEvent) {
                currentYear -= speed;
                if (currentYear <= END_YEAR) isPlaying = false;
                
                // UI Update
                document.getElementById('year-display').innerText = Math.floor(currentYear);
                document.getElementById('time-slider').value = START_YEAR - currentYear;

                checkEvents();
            }
            requestAnimationFrame(loop);
        }

        function checkEvents() {
            // Finde Event im aktuellen Jahr (+/- 0.5)
            const ev = script.find(e => Math.abs(e.year - currentYear) < 0.5);
            
            if (ev && activeEvent !== ev) {
                activeEvent = ev;
                triggerNarrative(ev);
                
                // Vektoren zeichnen (Pfeile)
                if (ev.vector) {
                    drawVector(ev.vector.from, ev.vector.to, actors.sea.color);
                }
                
                // Effekte (St√§dte fallen)
                if (ev.effect === 'ugarit_fall') destroyCity('Ugarit');
                if (ev.effect === 'hittite_fall') destroyCity('Hattusa');
                if (ev.effect === 'ugarit_fall') killRoute('tin'); // Zinnroute stirbt
            }
        }

        function triggerNarrative(ev) {
            const card = document.getElementById('story-card');
            const container = document.getElementById('narrative-container');
            
            // Inhalt setzen
            document.getElementById('card-title').innerText = ev.title;
            document.getElementById('card-date').innerText = ev.year + " v. Chr.";
            document.getElementById('card-desc').innerText = ev.desc;
            document.getElementById('card-quote').innerText = ev.quote;
            if (ev.img) document.getElementById('card-img').src = ev.img;

            // Anzeigen
            card.classList.remove('hidden');
            setTimeout(() => card.classList.add('active'), 50);
            
            // Automatisch Pause f√ºr Narrativ
            isPlaying = false;
            document.getElementById('play-icon').classList.replace('ph-pause', 'ph-play');
        }

        function closeNarrative() {
            const card = document.getElementById('story-card');
            card.classList.remove('active');
            setTimeout(() => {
                card.classList.add('hidden');
                // Vektoren l√∂schen
                layers.vectors.forEach(v => map.removeLayer(v));
                layers.vectors = [];
                activeEvent = null;
            }, 500);
        }

        /* --- VISUAL FX --- */
        function drawVector(from, to, color) {
            // SVG Pfeil
            const line = L.polyline([from, to], { color: color, weight: 4, opacity: 0.8 }).addTo(map);
            const head = L.marker(to, {
                icon: L.divIcon({
                    className: 'bg-transparent',
                    html: `<div class="attack-arrow vector-anim" style="color:${color}"><svg width="30" height="30" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"></path></svg></div>`,
                    iconSize: [30, 30], iconAnchor: [15, 15]
                })
            }).addTo(map);
            layers.vectors.push(line, head);
        }

        function destroyCity(name) {
            const c = layers.cities.find(x => x.data.name === name);
            if (c) {
                c.marker.setStyle({ color: '#000', fillColor: '#1c1917' }); // Schwarz
                // Feuer Icon
                L.marker(c.marker.getLatLng(), {
                    icon: L.divIcon({ html: 'üî•', className: 'text-2xl', iconSize: [20,20] })
                }).addTo(map);
            }
        }

        function killRoute(id) {
            const r = layers.routes.find(x => x.id === id);
            if (r) {
                r.line.getElement().classList.remove('route-line');
                r.line.getElement().classList.add('route-dead');
            }
        }

        /* --- AI LOGIC --- */
        async function askGeminiEvent() {
            if (!activeEvent) return;
            const prompt = `Analysiere das Ereignis "${activeEvent.title}" (${activeEvent.year} v. Chr.). Wer waren die Akteure? Warum war dies ein Systemkollaps? Antworte spannend wie ein Dokumentarfilm-Sprecher.`;
            openChat("Das Orakel", "üèõÔ∏è", "system", prompt);
        }

        function openActorChat(loc) {
            const actor = actors[loc.faction];
            const prompt = `Wir sind im Jahr ${Math.floor(currentYear)} v. Chr. ${actor.prompt} Wie ist die Lage in ${loc.name}?`;
            openChat(actor.name, actor.icon, "roleplay", prompt);
        }

        async function openChat(title, icon, mode, initialPrompt) {
            document.getElementById('chat-modal').classList.remove('hidden');
            document.getElementById('chat-role').innerText = title;
            document.getElementById('chat-avatar').innerText = icon;
            document.getElementById('chat-history').innerHTML = '';
            chatContext = []; // Reset

            // Initial Message
            addMsg("user", initialPrompt);
            addMsg("ai", "...", true);

            const key = getApiKey();
            if (!key) { addMsg("ai", "Fehler: Kein API Key."); return; }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: initialPrompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                document.getElementById('loading-msg').remove();
                addMsg("ai", text);
                chatContext.push({ role: "user", parts: [{ text: initialPrompt }] });
                chatContext.push({ role: "model", parts: [{ text: text }] });
            } catch (e) {
                addMsg("ai", "Verbindungsfehler.");
            }
        }

        async function sendMsg() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            
            addMsg("user", text);
            addMsg("ai", "...", true);
            
            const key = getApiKey();
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [...chatContext, { role: "user", parts: [{ text: text }] }] })
                });
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                document.getElementById('loading-msg').remove();
                addMsg("ai", reply);
                chatContext.push({ role: "user", parts: [{ text: text }] });
                chatContext.push({ role: "model", parts: [{ text: reply }] });
            } catch (e) {
                addMsg("ai", "Fehler.");
            }
        }

        function addMsg(role, text, loading = false) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            if (loading) div.id = 'loading-msg';
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' ? 'bg-stone-200 p-3 rounded-lg max-w-[80%]' : 'bg-white border border-stone-200 p-4 rounded-lg shadow-sm max-w-[90%] font-serif leading-relaxed';
            bubble.innerHTML = loading ? '‚åõ Analysiere...' : formatText(text);
            
            div.appendChild(bubble);
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = 99999;
        }

        /* --- UTILS --- */
        function getApiKey() {
            let key = localStorage.getItem('gemini_api_key');
            if (!key) setTimeout(() => document.getElementById('key-modal').classList.remove('hidden'), 1000);
            return key;
        }
        function saveApiKey() {
            const val = document.getElementById('api-key-input').value;
            if (val) { localStorage.setItem('gemini_api_key', val); location.reload(); }
        }
        function clearApiKey() { localStorage.removeItem('gemini_api_key'); location.reload(); }
        function closeChat() { document.getElementById('chat-modal').classList.add('hidden'); }
        function manualTime(val) { currentYear = START_YEAR - val; document.getElementById('year-display').innerText = Math.floor(currentYear); }
        function togglePlay() { 
            if (activeEvent) { closeNarrative(); isPlaying = true; } // Fortsetzen nach Event
            else { isPlaying = !isPlaying; }
            
            const icon = document.getElementById('play-icon');
            icon.classList.toggle('ph-play'); icon.classList.toggle('ph-pause');
        }
        function setSpeed(s) { speed = s; 
            ['1','2','3'].forEach(i => document.getElementById('spd-'+i).classList.remove('bg-white','shadow','text-stone-900'));
            const id = s < 0.1 ? '1' : (s < 0.3 ? '2' : '3');
            document.getElementById('spd-'+id).classList.add('bg-white','shadow','text-stone-900');
        }
        function formatText(t) { return t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); }

    </script>
</body>
</html>
