<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1177 v. Chr.: Das Ende der Zivilisation</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <script>
        /* --- SYSTEM & API --- */
        function getApiKey() {
            let key = localStorage.getItem('gemini_api_key');
            if (!key) {
                setTimeout(() => document.getElementById('key-modal').classList.remove('hidden'), 1000);
                return null;
            }
            return key;
        }
        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            if (input.value.trim()) {
                localStorage.setItem('gemini_api_key', input.value.trim());
                document.getElementById('key-modal').classList.add('hidden');
                location.reload(); 
            }
        }
        function clearApiKey() {
            localStorage.removeItem('gemini_api_key');
            location.reload();
        }
        function formatText(text) {
            return text ? text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') : '';
        }

        /* --- VISUELLE IDENTITÄTEN (SVGs) --- */
        const visuals = {
            egypt: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 10 L80 90 L20 90 Z' fill='%23eab308' stroke='%23854d0e' stroke-width='3'/%3E%3Ccircle cx='50' cy='40' r='10' fill='%231d4ed8'/%3E%3C/svg%3E`,
            hittite: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='20' width='60' height='60' rx='5' fill='%237f1d1d' stroke='%23450a0a' stroke-width='3'/%3E%3Cpath d='M30 50 L70 50 M50 30 L50 70' stroke='%23fca5a5' stroke-width='4'/%3E%3C/svg%3E`,
            mycenae: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='35' fill='%23ea580c' stroke='%237c2d12' stroke-width='3'/%3E%3Cpath d='M35 35 Q50 10 65 35 Q50 60 35 35' fill='none' stroke='%23fff7ed' stroke-width='2'/%3E%3C/svg%3E`,
            trade: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='30' fill='none' stroke='%23475569' stroke-width='4'/%3E%3Cpath d='M30 50 L70 50 M50 30 L50 70' stroke='%23475569' stroke-width='2'/%3E%3C/svg%3E`,
            sea_peoples: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M10 40 Q25 10 40 40 T70 40 T100 40' fill='none' stroke='%23dc2626' stroke-width='5'/%3E%3Cpath d='M10 60 Q25 90 40 60 T70 60 T100 60' fill='none' stroke='%23dc2626' stroke-width='5'/%3E%3C/svg%3E`
        };
    </script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Lato', sans-serif; background: #e5e5e5; overflow: hidden; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #d6d3d1; }
        
        /* UI Elements */
        .glass-panel { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .ui-layer { position: absolute; z-index: 3000; pointer-events: none; }
        .ui-element { pointer-events: auto; }
        
        /* Animations */
        @keyframes flow { to { stroke-dashoffset: -30; } }
        @keyframes pulse-collapse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0; } 100% { transform: scale(1); opacity: 0; } }
        @keyframes alert-pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* Map Styles */
        .trade-route { animation: flow 1s linear infinite; }
        .trade-route.interrupted { animation: none; stroke-dasharray: 2, 8; opacity: 0.4; filter: grayscale(100%); transition: all 2s ease; }
        
        .leaflet-tooltip.faction-label { background: transparent; border: none; font-family: 'Cinzel', serif; font-weight: bold; text-transform: uppercase; letter-spacing: 0.15em; font-size: 14px; text-shadow: 0 2px 4px rgba(255,255,255,0.9); }
        
        .collapse-marker { width: 40px; height: 40px; border-radius: 50%; background: #dc2626; animation: pulse-collapse 2s infinite; }
    </style>
</head>
<body class="text-stone-800">

    <div id="map"></div>

    <div class="ui-layer top-0 left-0 right-0 p-6 flex justify-between items-start">
        <div class="ui-element glass-panel px-6 py-4 rounded-xl border-l-4 border-amber-600">
            <h1 class="text-2xl font-cinzel font-bold text-stone-900">Die Erste Apokalypse</h1>
            <p class="text-xs text-stone-500 font-mono tracking-widest uppercase">Systemkollaps: 1220 – 1130 v. Chr.</p>
        </div>
        <div class="ui-element flex gap-2">
            <button onclick="clearApiKey()" class="bg-white/80 p-2 rounded-lg shadow hover:bg-red-50 text-stone-400 hover:text-red-600 transition-colors" title="Reset"><i class="ph-bold ph-key"></i></button>
        </div>
    </div>

    <div id="key-modal" class="hidden fixed inset-0 z-[9999] bg-stone-900/80 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 text-center">
            <h2 class="font-cinzel font-bold text-2xl mb-2">Die Archive öffnen</h2>
            <p class="text-sm text-stone-500 mb-6">Für die KI-Simulation wird ein API-Key benötigt.</p>
            <input type="password" id="api-key-input" placeholder="Google Gemini API Key" class="w-full p-3 bg-stone-100 rounded mb-4 font-mono text-sm">
            <button onclick="saveApiKey()" class="w-full bg-stone-800 text-white font-bold py-3 rounded hover:bg-stone-700">Verbinden</button>
        </div>
    </div>

    <div id="chat-modal" class="hidden fixed inset-0 z-[5000] bg-stone-900/40 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden border border-stone-200">
            <div class="bg-stone-100 p-4 border-b border-stone-200 flex justify-between items-center">
                <div>
                    <h3 class="font-cinzel font-bold text-lg flex items-center gap-2">
                        <i class="ph-fill ph-scroll text-amber-600"></i> <span id="chat-title">Historischer Diskurs</span>
                    </h3>
                    <p class="text-xs text-stone-500 font-mono" id="chat-context">Kontext: Jahr 1200 v. Chr.</p>
                </div>
                <button onclick="closeChat()" class="hover:bg-stone-200 rounded-full p-2"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="chat-history" class="flex-1 p-6 overflow-y-auto bg-stone-50 flex flex-col gap-4"></div>
            <div class="p-4 bg-white border-t border-stone-200 flex gap-2">
                <input type="text" id="chat-input" placeholder="Stellen Sie eine Nachfrage..." class="flex-1 border border-stone-300 rounded px-4 py-2 font-serif text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onkeypress="if(event.key === 'Enter') sendFollowUp()">
                <button onclick="sendFollowUp()" class="bg-stone-800 text-white px-4 py-2 rounded hover:bg-stone-700"><i class="ph-bold ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <div id="event-alert" class="hidden ui-layer top-24 left-1/2 -translate-x-1/2 ui-element">
        <button onclick="openEventChat()" class="glass-panel px-6 py-4 rounded-lg shadow-2xl border-l-4 border-red-600 flex items-center gap-5 hover:scale-105 transition-transform group max-w-lg text-left">
            <div class="bg-red-100 p-3 rounded-full animate-[alert-pulse_2s_infinite]">
                <i id="alert-icon" class="ph-fill ph-warning text-2xl text-red-600"></i>
            </div>
            <div>
                <span class="block text-[10px] font-bold text-red-600 uppercase tracking-widest mb-1">Ereignis-Alarm</span>
                <h2 id="alert-title" class="font-cinzel text-xl font-bold text-stone-900 leading-tight"></h2>
            </div>
            <div class="border-l border-stone-300 pl-4 ml-2">
                <i class="ph-bold ph-chat-centered-text text-stone-400 group-hover:text-amber-600 text-xl"></i>
            </div>
        </button>
    </div>

    <div class="ui-layer bottom-0 left-0 right-0 p-0 pointer-events-none">
        <div class="ui-element bg-white/95 border-t border-stone-200 shadow-2xl p-6 pb-8">
            <div class="max-w-5xl mx-auto flex items-center gap-8">
                <button id="play-btn" onclick="togglePlay()" class="w-14 h-14 bg-stone-800 hover:bg-amber-600 text-white rounded-full flex items-center justify-center shadow-lg transition-colors group flex-shrink-0">
                    <i id="play-icon" class="ph-fill ph-play text-2xl ml-1"></i>
                </button>

                <div class="flex-grow">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-stone-400">Chronologie</span>
                            <div class="font-cinzel text-3xl font-bold text-stone-800 tabular-nums">
                                <span id="year-display">1220</span> <span class="text-base text-stone-500">v. Chr.</span>
                            </div>
                        </div>
                        <div class="flex bg-stone-100 rounded p-1 gap-1">
                            <button onclick="setSpeed(0.05)" id="spd-slow" class="px-3 py-1 text-xs font-bold rounded bg-white shadow text-stone-800">1x</button>
                            <button onclick="setSpeed(0.15)" id="spd-med" class="px-3 py-1 text-xs font-bold rounded text-stone-500 hover:bg-white">3x</button>
                            <button onclick="setSpeed(0.4)" id="spd-fast" class="px-3 py-1 text-xs font-bold rounded text-stone-500 hover:bg-white">10x</button>
                        </div>
                    </div>
                    <input type="range" id="time-slider" min="0" max="90" value="0" step="0.1" oninput="manualTime(this.value)" class="w-full">
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /* --- CONFIGURATION --- */
        const START_YEAR = 1220;
        const END_YEAR = 1130;
        let currentYear = START_YEAR;
        let isPlaying = false;
        let baseSpeed = 0.05; // Standardgeschwindigkeit
        let currentSpeed = baseSpeed;
        let bulletTimeActive = false;
        let map;
        let activeEvent = null;
        let chatHistoryData = [];

        /* --- FACTIONS & DATA --- */
        const factions = {
            egypt: { name: "Ägyptisches Reich", color: "#eab308", loc: [29.5, 31.5], img: visuals.egypt, desc: "Das Neue Reich unter den Ramessiden." },
            hittite: { name: "Hethiter Großreich", color: "#7f1d1d", loc: [39.5, 34.5], img: visuals.hittite, desc: "Die Herren Anatoliens, regiert von Hattusa aus." },
            mycenae: { name: "Mykenische Paläste", color: "#ea580c", loc: [37.8, 22.5], img: visuals.mycenae, desc: "Ahhijawa. Ein Netzwerk aus Kriegerfürsten." },
            assyria: { name: "Assyrien", color: "#475569", loc: [36.0, 42.0], img: visuals.trade, desc: "Die aufsteigende Macht im Osten." }
        };

        const cities = [
            { name: "Mykene", lat: 37.73, lng: 22.75, faction: 'mycenae', fall: 1190, importance: 'high' },
            { name: "Knossos", lat: 35.29, lng: 25.13, faction: 'mycenae', fall: 1200, importance: 'med' },
            { name: "Troja (Wilusa)", lat: 39.95, lng: 26.24, faction: 'hittite', fall: 1180, importance: 'med' },
            { name: "Hattusa", lat: 40.01, lng: 34.61, faction: 'hittite', fall: 1178, importance: 'high' },
            { name: "Ugarit", lat: 35.60, lng: 35.78, faction: 'trade', fall: 1188, importance: 'critical' }, // Umschlagplatz!
            { name: "Kadesch", lat: 34.56, lng: 36.52, faction: 'hittite', fall: 1185, importance: 'med' },
            { name: "Aschkelon", lat: 31.66, lng: 34.57, faction: 'egypt', fall: 1177, importance: 'med' },
            { name: "Pi-Ramesse", lat: 30.79, lng: 31.82, faction: 'egypt', fall: 1100, importance: 'high' }, // Überlebt
            { name: "Enkomi (Alashiya)", lat: 35.16, lng: 33.88, faction: 'trade', fall: 1175, importance: 'critical' } // Kupferquelle
        ];

        // Handelsrouten: Start -> Ende. Wenn 'criticalNode' fällt, stirbt die Route.
        const tradeRoutes = [
            // ZINN ROUTE (Osten -> Ugarit -> Ägäis)
            { id: 'tin', path: [[35.5, 43.0], [36.0, 39.0], [35.6, 35.78]], type: 'tin', criticalNode: 'Ugarit', color: '#94a3b8' }, 
            { id: 'tin_sea', path: [[35.6, 35.78], [35.2, 33.9], [35.3, 25.1], [37.7, 22.7]], type: 'tin', criticalNode: 'Ugarit', color: '#94a3b8' },
            // KUPFER ROUTE (Zypern -> Ägypten & Hethiter)
            { id: 'copper_sth', path: [[35.16, 33.88], [32.0, 34.0], [30.8, 31.8]], type: 'copper', criticalNode: 'Enkomi (Alashiya)', color: '#d97706' },
            { id: 'copper_nrt', path: [[35.16, 33.88], [36.5, 34.5], [40.0, 34.6]], type: 'copper', criticalNode: 'Enkomi (Alashiya)', color: '#d97706' }
        ];

        const events = [
            { year: 1207, title: "Merenptah-Stele", desc: "Erster Angriff libyscher Stämme und Seevölker auf Ägypten abgewehrt.", icon: "ph-shield", loc: [30.8, 31.8] },
            { year: 1190, title: "Der Brand von Ugarit", desc: "Das Handelszentrum der Welt wird vernichtet. Tontafeln berichten: 'Feindliche Schiffe sind da, Städte brennen.'", icon: "ph-fire", loc: [35.6, 35.78], aiPrompt: "Du bist der letzte Schreiber von Ugarit. Beschreibe die letzten Stunden der Stadt." },
            { year: 1180, title: "Fall von Hattusa", desc: "Die hethitische Hauptstadt wird aufgegeben und geht in Flammen auf. Das Großreich kollabiert.", icon: "ph-columns", loc: [40.0, 34.6] },
            { year: 1177, title: "Schlacht im Nildelta", desc: "Ramses III. stellt die Seevölker zur Entscheidungsschlacht. Ägypten überlebt, aber das internationale System ist tot.", icon: "ph-swords", loc: [31.5, 31.0], aiPrompt: "Du bist ein General von Ramses III. Berichte dem Pharao vom Sieg über die Fremden aus dem Meer." }
        ];

        const layers = { cities: [], routes: [], vectors: [] };

        /* --- INITIALIZATION --- */
        window.onload = function() {
            getApiKey();
            initMap();
            initLayers();
            requestAnimationFrame(gameLoop);
        };

        function initMap() {
            // Neuer Fokus: Östliches Mittelmeer (inkl. Ägypten!)
            map = L.map('map', { 
                zoomControl: false, attributionControl: false, zoomSnap: 0.1 
            }).setView([34.5, 33.0], 5.5);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '©OpenStreetMap, ©CartoDB'
            }).addTo(map);

            // Faction Labels
            Object.values(factions).forEach(f => {
                L.tooltip({ permanent: true, direction: 'center', className: 'faction-label' })
                 .setContent(`<span style="color:${f.color}">${f.name}</span>`)
                 .setLatLng(f.loc).addTo(map);
            });
        }

        function initLayers() {
            // Routen zeichnen
            tradeRoutes.forEach(route => {
                const line = L.polyline(route.path, {
                    color: route.color, weight: 3, dashArray: '4, 8', className: 'trade-route'
                }).addTo(map);
                layers.routes.push({ el: line, data: route });
            });

            // Städte zeichnen
            cities.forEach(city => {
                const f = factions[city.faction] || { color: '#555' };
                const radius = city.importance === 'critical' ? 8 : (city.importance === 'high' ? 6 : 4);
                
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: radius, color: '#fff', fillColor: f.color, weight: 1.5, fillOpacity: 1
                }).addTo(map);

                marker.bindTooltip(city.name, { permanent: true, direction: 'top', className: 'bg-white/90 border border-stone-300 px-1 text-[10px] font-serif' });
                marker.on('click', () => openContextChat(city.name, city.faction));
                
                layers.cities.push({ el: marker, data: city });
            });
        }

        /* --- GAME LOOP --- */
        function gameLoop() {
            if (isPlaying) {
                // Bullet Time Logik
                let step = currentSpeed;
                if (bulletTimeActive) step = step * 0.1; // 90% langsamer bei Events
                
                currentYear -= step;
                if (currentYear <= END_YEAR) {
                    isPlaying = false;
                    document.getElementById('play-icon').classList.replace('ph-pause', 'ph-play');
                }
                
                // UI Sync
                const sliderVal = START_YEAR - currentYear;
                document.getElementById('time-slider').value = sliderVal;
                updateSim();
            }
            requestAnimationFrame(gameLoop);
        }

        function manualTime(val) {
            currentYear = START_YEAR - parseFloat(val);
            updateSim();
        }

        function updateSim() {
            document.getElementById('year-display').innerText = Math.floor(currentYear);

            // 1. Events Check
            const ev = events.find(e => Math.abs(e.year - currentYear) < 0.5);
            if (ev && activeEvent !== ev) {
                activeEvent = ev;
                triggerAlert(ev);
                bulletTimeActive = true; // Automatisch verlangsamen
            } else if (!ev && activeEvent) {
                activeEvent = null;
                document.getElementById('event-alert').classList.add('hidden');
                bulletTimeActive = false; // Speed wieder normal
            }

            // 2. Städte Status (Zerstörung)
            layers.cities.forEach(obj => {
                if (currentYear <= obj.data.fall && !obj.destroyed) {
                    obj.destroyed = true;
                    // Visueller Kollaps
                    obj.el.setStyle({ fillColor: '#1c1917', color: '#000' });
                    // Explosionseffekt hinzufügen
                    const boom = L.divIcon({ className: 'bg-transparent', html: '<div class="collapse-marker"></div>' });
                    L.marker(obj.el.getLatLng(), { icon: boom, zIndexOffset: 1000 }).addTo(map);
                } else if (currentYear > obj.data.fall && obj.destroyed) {
                    // Reset (wenn man zurückspult)
                    obj.destroyed = false;
                    const f = factions[obj.data.faction] || { color: '#555' };
                    obj.el.setStyle({ fillColor: f.color });
                }
            });

            // 3. Handelsrouten (Unterbrechung)
            layers.routes.forEach(obj => {
                const node = cities.find(c => c.name === obj.data.criticalNode);
                if (node && currentYear <= node.fall) {
                    // Node ist gefallen -> Route tot
                    obj.el.getElement()?.classList.add('interrupted');
                    obj.el.setStyle({ color: '#57534e' });
                } else {
                    obj.el.getElement()?.classList.remove('interrupted');
                    obj.el.setStyle({ color: obj.data.color });
                }
            });
        }

        /* --- CONTROLS --- */
        function togglePlay() {
            isPlaying = !isPlaying;
            const icon = document.getElementById('play-icon');
            icon.classList.toggle('ph-play');
            icon.classList.toggle('ph-pause');
        }

        function setSpeed(spd) {
            baseSpeed = spd;
            currentSpeed = spd;
            // UI Update
            ['slow', 'med', 'fast'].forEach(id => {
                const btn = document.getElementById('spd-' + id);
                btn.classList.remove('bg-white', 'shadow', 'text-stone-800');
                btn.classList.add('text-stone-500', 'hover:bg-white');
            });
            let activeId = spd < 0.1 ? 'slow' : (spd < 0.2 ? 'med' : 'fast');
            const active = document.getElementById('spd-' + activeId);
            active.classList.add('bg-white', 'shadow', 'text-stone-800');
            active.classList.remove('text-stone-500');
        }

        function triggerAlert(ev) {
            const el = document.getElementById('event-alert');
            document.getElementById('alert-title').innerText = ev.title;
            document.getElementById('alert-icon').className = `ph-fill ${ev.icon} text-2xl text-red-600`;
            el.classList.remove('hidden');
        }

        /* --- AI CHAT SYSTEM (COMPLETE) --- */
        async function callGemini(prompt) {
            const key = getApiKey();
            if (!key) return "Bitte API Key eingeben.";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [...chatHistoryData, { role: "user", parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                return "Fehler bei der Verbindung zum Orakel: " + e.message;
            }
        }

        function openEventChat() {
            if (!activeEvent) return;
            const prompt = activeEvent.aiPrompt || `Das Ereignis '${activeEvent.title}' im Jahr ${activeEvent.year} v. Chr. Analysiere Ursachen und Folgen für das Weltsystem der Bronzezeit.`;
            initChat(activeEvent.title, prompt, "system");
        }

        function openContextChat(name, factionKey) {
            const f = factions[factionKey];
            const title = f ? f.name : name;
            const year = Math.floor(currentYear);
            const prompt = `Wir schreiben das Jahr ${year} v. Chr. Ich interessiere mich für ${name} (${title}). Wie ist die wirtschaftliche und militärische Lage? Droht Gefahr durch die Seevölker oder Versorgungsmangel? Antworte kurz und präzise.`;
            initChat(title, prompt, "context");
        }

        async function initChat(title, initialPrompt, mode) {
            document.getElementById('chat-modal').classList.remove('hidden');
            document.getElementById('chat-title').innerText = title;
            document.getElementById('chat-context').innerText = `Jahr: ${Math.floor(currentYear)} v. Chr.`;
            const histDiv = document.getElementById('chat-history');
            histDiv.innerHTML = '';
            chatHistoryData = []; // Reset History

            // System Instruction
            const sysPrompt = "Du bist ein Experte für die Spätbronzezeit. Antworte in einem gehobenen, leicht altertümlichen, aber verständlichen Stil. Sei historisch präzise (Hethiter, Mykener, Ägypten).";
            chatHistoryData.push({ role: "user", parts: [{ text: sysPrompt }] });
            chatHistoryData.push({ role: "model", parts: [{ text: "Verstanden. Ich bin bereit." }] });

            addMessage("user", initialPrompt);
            addMessage("ai", "Das Orakel denkt nach...", true);

            const response = await callGemini(initialPrompt);
            removeLoading();
            addMessage("ai", response);
            
            chatHistoryData.push({ role: "user", parts: [{ text: initialPrompt }] });
            chatHistoryData.push({ role: "model", parts: [{ text: response }] });
        }

        async function sendFollowUp() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            addMessage("user", text);
            addMessage("ai", "...", true);
            
            const response = await callGemini(text);
            removeLoading();
            addMessage("ai", response);

            chatHistoryData.push({ role: "user", parts: [{ text: text }] });
            chatHistoryData.push({ role: "model", parts: [{ text: response }] });
        }

        function addMessage(role, text, isLoading = false) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            if (isLoading) div.id = 'loading-msg';
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' 
                ? 'bg-stone-200 text-stone-800 rounded-lg rounded-tr-none px-4 py-2 max-w-[80%]' 
                : 'bg-white border border-stone-200 text-stone-900 rounded-lg rounded-tl-none px-4 py-3 max-w-[90%] shadow-sm font-serif leading-relaxed';
            
            bubble.innerHTML = isLoading ? '<i class="ph-bold ph-spinner animate-spin"></i>' : formatText(text);
            div.appendChild(bubble);
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = 9999;
        }

        function removeLoading() {
            const el = document.getElementById('loading-msg');
            if (el) el.remove();
        }

        function closeChat() {
            document.getElementById('chat-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
