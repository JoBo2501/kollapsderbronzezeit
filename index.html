<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1177 v. Chr.: Der Systemkollaps der Bronzezeit</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <script>
        /* --- API & UTIL --- */
        function getApiKey() {
            let key = localStorage.getItem('gemini_api_key');
            if (!key) {
                setTimeout(() => document.getElementById('key-modal').classList.remove('hidden'), 1000);
                return null;
            }
            return key;
        }
        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('key-modal').classList.add('hidden');
                alert("Verbindung zum Orakel hergestellt.");
                location.reload(); 
            }
        }
        function clearApiKey() {
            localStorage.removeItem('gemini_api_key');
            location.reload();
        }
        function formatText(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        /* --- VISUELLE ARTEFAKTE (SVG) --- */
        const artifacts = {
            ingot: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23b45309'%3E%3Cpath d='M10 30 Q25 40 40 30 L60 30 Q75 40 90 30 L90 70 Q75 60 60 70 L40 70 Q25 60 10 70 Z' stroke='%2378350f' stroke-width='2'/%3E%3C/svg%3E`,
            tablet: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23d6d3d1'%3E%3Crect x='15' y='10' width='70' height='80' rx='5' stroke='%2357534e' stroke-width='2'/%3E%3Cpath d='M20 20 H80 M20 30 H80 M20 40 H80 M20 50 H80 M20 60 H80' stroke='%23a8a29e' stroke-width='1'/%3E%3C/svg%3E`,
            chariot: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='70' cy='70' r='20' fill='none' stroke='%23b45309' stroke-width='4'/%3E%3Cpath d='M70 70 L40 40 L20 40' stroke='%2378350f' stroke-width='3'/%3E%3Crect x='30' y='30' width='20' height='20' fill='%23b45309'/%3E%3C/svg%3E`,
            seapeople: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 20 C50 20 80 10 80 40 L50 90 L20 40 C20 10 50 20 50 20' fill='%231e293b' stroke='%23dc2626' stroke-width='2'/%3E%3Cpath d='M20 30 L80 30' stroke='%23dc2626' stroke-width='2'/%3E%3Cpath d='M50 20 L50 10' stroke='%23dc2626' stroke-width='4'/%3E%3C/svg%3E`
        };
        const battleArrowSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor"><path d="M238.63,114.34l-80-80a8,8,0,0,0-11.32,0L128,53.66V24A16,16,0,0,0,112,8H32A16,16,0,0,0,16,24V168a16,16,0,0,0,16,16h80a16,16,0,0,0,16-16V138.34l19.31,19.32a8,8,0,0,0,11.32,0l80-80A8,8,0,0,0,238.63,114.34Z"/></svg>`;

    </script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Lato', sans-serif; background: #f5f5f4; }
        h1, h2, h3, .font-cinzel { font-family: 'Cinzel', serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #e7e5e4; }
        
        /* UI Layering */
        .ui-layer { position: absolute; z-index: 3000; pointer-events: none; }
        .ui-element { pointer-events: auto; }
        
        /* Controls */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #b45309; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.5); cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #a8a29e; border-radius: 2px; }

        /* Animations */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        @keyframes flow-dash { to { stroke-dashoffset: -20; } }
        
        .route-line { animation: flow-dash 2s linear infinite; }
        .route-tin { stroke: #64748b; } /* Zinn = Grau/Silber */
        .route-copper { stroke: #d97706; } /* Kupfer = Bronze/Orange */
        .route-sea { stroke: #dc2626; stroke-dasharray: 4, 8; } /* Seevölker = Rot */

        .city-marker { transition: all 0.5s ease; }
        .city-destroyed { filter: grayscale(100%) brightness(50%); stroke: #000; fill: #444; }
        
        .pulse-icon:after { content: ''; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; border: 2px solid #dc2626; animation: pulse-red 2s infinite; }
        
        /* Tooltips */
        .leaflet-tooltip.region-label { background: transparent; border: none; box-shadow: none; font-family: 'Cinzel', serif; font-weight: bold; color: #57534e; text-transform: uppercase; letter-spacing: 0.2em; font-size: 16px; opacity: 0.6; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        .leaflet-tooltip.custom-label { background: rgba(255,255,255,0.95); border: 1px solid #a8a29e; font-family: 'Cinzel', serif; color: #444; font-size: 11px; padding: 2px 6px; }

        /* Custom Visuals */
        .vector-arrow { filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
        
        /* Glassmorphism Cards */
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="text-stone-800">

    <div id="map"></div>

    <div class="ui-layer top-0 left-0 right-0 p-6 pointer-events-none flex justify-between items-start">
        <div class="ui-element glass-panel px-6 py-4 rounded-xl border-l-4 border-amber-600">
            <h1 class="text-2xl font-bold text-stone-900 leading-none">Der Untergang der Bronzezeit</h1>
            <p class="text-xs text-stone-500 font-mono mt-1 tracking-widest uppercase">Systemkollaps ca. 1220 – 1150 v. Chr.</p>
        </div>
        
        <div class="ui-element flex gap-2">
            <button onclick="clearApiKey()" class="bg-white/80 hover:bg-white p-2 rounded-lg shadow text-stone-400 hover:text-red-500 transition-colors" title="Reset API">
                <i class="ph-bold ph-key"></i>
            </button>
        </div>
    </div>

    <div id="key-modal" class="hidden fixed inset-0 z-[9999] bg-stone-900/80 backdrop-blur-sm flex items-center justify-center p-4 ui-element">
        <div class="bg-stone-100 rounded-xl shadow-2xl w-full max-w-md p-8 text-center border border-stone-300">
            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-fill ph-scroll text-amber-700 text-3xl"></i>
            </div>
            <h2 class="font-cinzel font-bold text-2xl text-stone-800 mb-2">Die Archive öffnen</h2>
            <p class="text-sm text-stone-500 mb-6">Für die KI-Analyse der Tontafeln wird ein API-Key benötigt.</p>
            <input type="password" id="api-key-input" placeholder="Google Gemini API Key" class="w-full p-3 bg-white border border-stone-300 rounded-lg mb-4 font-mono text-sm focus:ring-2 focus:ring-amber-500 outline-none">
            <button onclick="saveApiKey()" class="w-full bg-stone-800 hover:bg-stone-700 text-amber-50 font-bold py-3 rounded-lg transition-colors tracking-wide uppercase text-sm">Verbindung herstellen</button>
        </div>
    </div>

    <div id="info-box" class="hidden ui-layer top-24 right-4 w-[380px] max-h-[70vh] flex flex-col glass-panel rounded-xl overflow-hidden shadow-2xl ui-element transition-all duration-300">
        <div class="relative h-40 bg-stone-200 flex items-center justify-center overflow-hidden border-b border-stone-300">
            <img id="info-img" src="" class="h-full w-auto object-contain opacity-80 mix-blend-multiply">
            <div class="absolute top-2 right-2">
                <button onclick="closeInfo()" class="bg-white/50 hover:bg-white rounded-full p-1 text-stone-600"><i class="ph-bold ph-x"></i></button>
            </div>
        </div>
        <div class="p-6 overflow-y-auto">
            <span id="info-type" class="text-[10px] font-bold uppercase tracking-widest text-amber-600 mb-1 block">Ressource</span>
            <h2 id="info-title" class="font-cinzel text-xl font-bold text-stone-800 mb-2"></h2>
            <div id="info-quote" class="text-xs italic text-stone-500 border-l-2 border-stone-400 pl-3 mb-4 font-serif"></div>
            <p id="info-text" class="text-sm leading-relaxed text-stone-700 mb-4"></p>
            
            <div id="ai-response-area" class="hidden mt-4 pt-4 border-t border-stone-200">
                <div class="text-[10px] uppercase font-bold text-stone-400 mb-2 flex items-center gap-1">
                    <i class="ph-fill ph-sparkle text-purple-500"></i> KI-Interpretation
                </div>
                <div id="ai-text" class="text-sm text-stone-800 bg-purple-50 p-3 rounded border border-purple-100 italic"></div>
            </div>
            
            <button id="ai-ask-btn" onclick="askAIContext()" class="w-full mt-4 bg-stone-100 hover:bg-purple-50 border border-stone-300 hover:border-purple-300 text-stone-600 hover:text-purple-700 py-2 rounded text-xs font-bold transition-colors flex items-center justify-center gap-2">
                <i class="ph-bold ph-chat-centered-text"></i> Den Schreiber befragen
            </button>
        </div>
    </div>

    <div id="event-alert" class="hidden ui-layer top-24 left-1/2 -translate-x-1/2 ui-element">
        <div class="glass-panel px-8 py-5 rounded-lg shadow-2xl border-l-8 border-red-600 flex items-center gap-6 max-w-xl cursor-pointer hover:scale-105 transition-transform" onclick="expandEventAI()">
            <div class="bg-red-50 p-3 rounded-full border border-red-100">
                <i id="alert-icon" class="ph-fill ph-fire text-3xl text-red-600"></i>
            </div>
            <div>
                <span class="block text-xs font-bold text-red-600 uppercase tracking-widest mb-1">Historische Zäsur</span>
                <h2 id="alert-title" class="font-cinzel text-2xl font-bold text-stone-900"></h2>
                <p id="alert-desc" class="text-sm text-stone-600 mt-1"></p>
            </div>
            <i class="ph-bold ph-caret-right text-stone-400"></i>
        </div>
    </div>

    <div class="ui-layer bottom-0 left-0 right-0 p-0 pointer-events-none">
        <div class="ui-element bg-white/95 border-t border-stone-300 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] p-6 pb-8">
            <div class="max-w-4xl mx-auto flex items-center gap-8">
                
                <button id="play-btn" onclick="togglePlay()" class="flex-shrink-0 w-16 h-16 bg-stone-800 hover:bg-amber-700 text-amber-50 rounded-full flex items-center justify-center shadow-lg transition-colors group">
                    <i id="play-icon" class="ph-fill ph-play text-2xl group-hover:scale-110 transition-transform"></i>
                </button>

                <div class="flex-grow">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-stone-400">Jahr</span>
                            <div class="font-cinzel text-4xl font-bold text-stone-800 tabular-nums leading-none">
                                <span id="year-display">1220</span> <span class="text-lg text-stone-500">v. Chr.</span>
                            </div>
                        </div>
                        <div class="flex gap-4 text-[10px] font-bold uppercase tracking-wider text-stone-500">
                            <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-amber-600"></div> Kupfer</div>
                            <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-slate-500"></div> Zinn</div>
                            <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div> Seevölker</div>
                        </div>
                    </div>
                    <input type="range" id="time-slider" min="0" max="100" value="0" step="0.2" oninput="updateTime(this.value)">
                    <div class="flex justify-between text-[10px] text-stone-400 font-mono mt-1">
                        <span>1220 (Blütezeit)</span>
                        <span>1177 (Jahr des Untergangs)</span>
                        <span>1120 (Dunkles Zeitalter)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /* --- CONFIG --- */
        const START_YEAR = 1220;
        const END_YEAR = 1120; // Wir zählen runter!
        let currentYear = START_YEAR;
        let isPlaying = false;
        let map;
        let layers = { routes: [], cities: [], vectors: [] };
        let activeEvent = null;

        /* --- GEO DATA --- */
        // Städte der Bronzezeit
        const cities = [
            { name: "Mykene", lat: 37.73, lng: 22.75, type: 'palace', status: 'active', fallYear: 1190 },
            { name: "Pylos", lat: 36.96, lng: 21.70, type: 'palace', status: 'active', fallYear: 1180 },
            { name: "Troja (Wilusa)", lat: 39.95, lng: 26.24, type: 'city', status: 'active', fallYear: 1185 },
            { name: "Hattusa", lat: 40.02, lng: 34.61, type: 'capital', status: 'active', fallYear: 1178 }, // Hethiter Hauptstadt
            { name: "Ugarit", lat: 35.60, lng: 35.78, type: 'trade', status: 'active', fallYear: 1190 }, // Wichtigster Hafen!
            { name: "Alashiya (Enkomi)", lat: 35.16, lng: 33.88, type: 'resource', status: 'active', fallYear: 1175 }, // Zypern (Kupfer)
            { name: "Aschkelon", lat: 31.66, lng: 34.57, type: 'city', status: 'active', fallYear: 1177 },
            { name: "Pi-Ramesse", lat: 30.79, lng: 31.82, type: 'capital', status: 'active', fallYear: 1100 } // Ägypten überlebt (verliert aber Macht)
        ];

        // Handelsrouten (Logistik)
        const logistics = [
            {
                id: 'tin-east', resource: 'Zinn (aus Osten)', color: '#64748b', active: true,
                path: [[36.0, 44.0], [36.0, 41.0], [35.6, 35.8]], // Mari -> Ugarit (stilisiert)
                desc: "Zinn aus Afghanistan. Ohne dieses Metall gibt es keine Bronze. Die Route ist extrem lang und anfällig.",
                cutOffYear: 1185 // Wenn Ugarit fällt, stoppt der Zinnfluss
            },
            {
                id: 'copper-cyprus', resource: 'Kupfer (Alashiya)', color: '#d97706', active: true,
                path: [[35.16, 33.88], [35.6, 35.8], [36.8, 30.0], [37.7, 22.7]], // Zypern -> Levant & Zypern -> Ägäis
                desc: "Alashiya (Zypern) ist der Kupfer-Gigant. Hunderte Tonnen Oxhide-Barren werden verschifft.",
                cutOffYear: 1175 // Seevölker Invasion Zyperns
            },
            {
                id: 'tin-west', resource: 'Zinn (Atlantik)', color: '#94a3b8', active: true,
                path: [[42.0, 12.0], [38.0, 20.0], [37.0, 21.7]], // Italien -> Griechenland (stilisiert)
                desc: "Eine fragile, spekulative Route für Zinn und Bernstein aus dem fernen Europa.",
                cutOffYear: 1190 // Zusammenbruch Mykenes
            }
        ];

        // Ereignisse
        const events = [
            { year: 1208, lat: 31.0, lng: 29.0, title: "Schlacht gegen Libyer & Seevölker", desc: "Pharao Merenptah wehrt den ersten Ansturm ab.", icon: "ph-shield" },
            { year: 1190, lat: 35.6, lng: 35.8, title: "Der Fall von Ugarit", desc: "'Meine Schiffe sind im Lukka-Land... der Feind ist da.' Die Stadt brennt.", type: "collapse", icon: "ph-fire" },
            { year: 1180, lat: 40.0, lng: 34.6, title: "Ende des Hethiterreichs", desc: "Hattusa wird aufgegeben und brennt. Hungersnöte treiben das System in den Ruin.", type: "collapse", icon: "ph-columns" },
            { year: 1177, lat: 31.0, lng: 31.5, title: "Schlacht im Nildelta", desc: "Ramses III. stoppt die Seevölker. 'Sie kamen als Flamme, die kein Land hielt.'", type: "battle", icon: "ph-swords" }
        ];

        // Vektoren (Bewegungen der Seevölker)
        const vectors = [
            { start: 1200, end: 1190, path: [[40.0, 18.0], [35.0, 24.0]], color: '#dc2626' }, // Adria -> Kreta
            { start: 1190, end: 1185, path: [[36.0, 28.0], [35.0, 33.0]], color: '#dc2626' }, // Rhodos -> Zypern
            { start: 1185, end: 1177, path: [[35.0, 33.0], [34.0, 35.0], [31.5, 34.0]], color: '#dc2626' } // Zypern -> Levant -> Ägypten
        ];

        /* --- INIT --- */
        window.onload = function() {
            initMap();
            getApiKey();
            renderFrame(START_YEAR);
        };

        function initMap() {
            map = L.map('map', { 
                zoomControl: false, 
                attributionControl: false,
                scrollWheelZoom: false,
                zoomSnap: 0.1
            }).setView([36.0, 28.0], 5.5); // Fokus Östliches Mittelmeer

            // CartoDB Voyager (clean, gute Farben für Antike)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Regions-Labels
            const regions = [
                { t: "HETHTITER (HATTI)", c: [39.5, 34.0] },
                { t: "MYKENE (AHHIJAWA)", c: [38.0, 23.0] },
                { t: "ÄGYPTEN", c: [29.0, 31.0] },
                { t: "ASSYRIEN", c: [36.0, 41.0] },
                { t: "KANAAN", c: [32.0, 35.5] }
            ];
            regions.forEach(r => {
                L.tooltip({ permanent: true, direction: 'center', className: 'region-label' })
                 .setContent(r.t).setLatLng(r.c).addTo(map);
            });

            // Städte initialisieren
            cities.forEach(c => {
                const color = c.type === 'resource' ? '#d97706' : '#444';
                const radius = c.type === 'capital' ? 8 : 5;
                const m = L.circleMarker([c.lat, c.lng], {
                    radius: radius, color: '#fff', fillColor: color, weight: 2, fillOpacity: 1
                }).addTo(map);
                m.bindTooltip(c.name, { permanent: true, direction: 'bottom', className: 'custom-label', offset: [0, 5] });
                // Klick-Event für Kontext
                m.on('click', () => showInfo(c.name, "Zentrum der Palastwirtschaft.", c.type === 'resource' ? artifacts.ingot : artifacts.tablet, "Systemknoten"));
                layers.cities.push({ data: c, marker: m });
            });

            // Routen initialisieren
            logistics.forEach(l => {
                const line = L.polyline(l.path, {
                    className: 'route-line ' + (l.resource.includes('Zinn') ? 'route-tin' : 'route-copper'),
                    weight: 3, opacity: 0.8, dashArray: '5, 10'
                }).addTo(map);
                line.on('click', () => showInfo(l.resource, l.desc, artifacts.ingot, "Logistik-Ader"));
                layers.routes.push({ data: l, line: line });
            });
        }

        /* --- LOGIC LOOP --- */
        function renderFrame(year) {
            // Update UI
            document.getElementById('year-display').innerText = Math.floor(year);
            const slider = document.getElementById('time-slider');
            // Mapping: Slider 0 = 1220, 100 = 1120. 
            // Also: year = 1220 - val. val = 1220 - year.
            if(Math.abs(year - currentYear) > 0.1) slider.value = START_YEAR - year;

            // 1. Ereignisse checken
            const ev = events.find(e => Math.abs(e.year - year) < 0.8);
            if (ev && activeEvent !== ev) {
                activeEvent = ev;
                showAlert(ev);
                if(isPlaying) togglePlay(); // Bullet Time Pause bei Event
            } else if (!ev) {
                hideAlert();
                activeEvent = null;
            }

            // 2. Städte Status (Zerstörung)
            layers.cities.forEach(item => {
                if (year <= item.data.fallYear && item.data.status === 'active') {
                    // Stadt fällt in diesem Jahr (oder ist schon gefallen)
                    item.marker.setStyle({ fillColor: '#1c1917', color: '#78716c' }); // Schwarz/Grau
                    item.marker.getTooltip().getElement()?.classList.add('line-through', 'text-stone-400');
                    // Füge Feuer-Icon hinzu (kurz)
                    if (year > item.data.fallYear - 2) {
                        // Brand-Effekt
                    }
                } else if (year > item.data.fallYear) {
                    // Reset beim Zurückspulen
                    const color = item.data.type === 'resource' ? '#d97706' : '#444';
                    item.marker.setStyle({ fillColor: color, color: '#fff' });
                    item.marker.getTooltip().getElement()?.classList.remove('line-through', 'text-stone-400');
                }
            });

            // 3. Logistik Unterbrechung
            layers.routes.forEach(item => {
                if (year <= item.data.cutOffYear) {
                    item.line.setStyle({ color: '#ef4444', dashArray: '1, 10', opacity: 0.3, weight: 1 }); // Route tot
                } else {
                    const baseColor = item.data.resource.includes('Zinn') ? '#64748b' : '#d97706';
                    item.line.setStyle({ color: baseColor, dashArray: '5, 10', opacity: 0.8, weight: 3 });
                }
            });

            // 4. Vektoren (Seevölker Bewegung)
            // Cleanup alte Pfeile
            layers.vectors.forEach(v => map.removeLayer(v));
            layers.vectors = [];
            
            vectors.forEach(v => {
                if (year <= v.start && year >= v.end) {
                    // Interpolation
                    const progress = (v.start - year) / (v.start - v.end); // 0 bis 1
                    // Einfache Linie zeichnen, die wächst
                    const p1 = v.path[0];
                    const pLast = v.path[v.path.length-1];
                    // (Für echte Interpolation entlang Polyline bräuchte man mehr Mathe, hier vereinfacht: Zeige Pfeil am Kopf)
                    
                    // Wir zeichnen den kompletten Pfad progressiv
                    const currentLine = L.polyline(v.path, { color: v.color, weight: 6, opacity: 0.6 }).addTo(map);
                    layers.vectors.push(currentLine);
                    
                    // Pfeilspitze
                    const icon = L.divIcon({ 
                        className: 'bg-transparent', 
                        html: `<div class="vector-arrow text-red-600 rotate-180 transform"><svg width="40" height="40" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"></path></svg></div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    
                    // Grobe Positionsbestimmung für den Pfeil (Mitte oder Ende je nach Fortschritt)
                    // Hier vereinfacht: Pfeil am Zielort, wenn aktiv
                    if(progress > 0.1) {
                        const m = L.marker(v.path[v.path.length-1], { icon: icon, zIndexOffset: 1000 }).addTo(map);
                        layers.vectors.push(m);
                    }
                }
            });
        }

        function updateTime(val) {
            currentYear = START_YEAR - parseFloat(val);
            renderFrame(currentYear);
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('play-icon');
            if(isPlaying) {
                btn.classList.replace('ph-play', 'ph-pause');
                loop();
            } else {
                btn.classList.replace('ph-pause', 'ph-play');
            }
        }

        function loop() {
            if(!isPlaying) return;
            if(currentYear > END_YEAR) {
                currentYear -= 0.15; // Geschwindigkeit
                renderFrame(currentYear);
                requestAnimationFrame(loop);
            } else {
                isPlaying = false;
                document.getElementById('play-icon').classList.replace('ph-pause', 'ph-play');
            }
        }

        /* --- UI INTERACTION --- */
        function showAlert(ev) {
            const el = document.getElementById('event-alert');
            document.getElementById('alert-title').innerText = ev.title;
            document.getElementById('alert-desc').innerText = ev.desc;
            document.getElementById('alert-icon').className = `ph-fill ${ev.icon} text-3xl text-red-600`;
            el.classList.remove('hidden');
        }
        function hideAlert() {
            document.getElementById('event-alert').classList.add('hidden');
        }

        function showInfo(title, text, img, type) {
            const el = document.getElementById('info-box');
            document.getElementById('info-title').innerText = title;
            document.getElementById('info-text').innerText = text;
            document.getElementById('info-type').innerText = type;
            document.getElementById('info-img').src = img;
            
            // Kontext-Variable setzen für KI
            window.currentContext = { title, year: Math.floor(currentYear) };
            
            document.getElementById('ai-response-area').classList.add('hidden');
            el.classList.remove('hidden');
        }
        function closeInfo() {
            document.getElementById('info-box').classList.add('hidden');
        }

        /* --- AI LOGIC --- */
        async function askAIContext() {
            const ctx = window.currentContext;
            const btn = document.getElementById('ai-ask-btn');
            const output = document.getElementById('ai-text');
            const area = document.getElementById('ai-response-area');
            
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Entziffere Tontafel...';
            area.classList.remove('hidden');
            output.innerText = "Lade...";

            const key = getApiKey();
            if(!key) { output.innerText = "Kein Schlüssel vorhanden."; return; }

            const prompt = `Du bist ein Schreiber am Hof von Ugarit oder Ägypten im Jahr ${ctx.year} v. Chr. Situation: Die Welt bricht zusammen (Bronzezeit-Kollaps). Thema: "${ctx.title}". Beschreibe die Lage in 2-3 dramatischen, aber historisch korrekten Sätzen. Erwähne Rohstoffmangel oder Feinde. Verwende altertümliche, aber verständliche Sprache.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                output.innerText = text;
                btn.innerHTML = '<i class="ph-bold ph-check"></i> Fertig';
            } catch(e) {
                output.innerText = "Die Tafel ist zerbrochen (API Fehler).";
                btn.innerHTML = '<i class="ph-bold ph-warning"></i> Fehler';
            }
        }
    </script>
</body>
</html>